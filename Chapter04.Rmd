---
title: "样本容量估计"
author: "梁雪枫"
date: "2014年11月18日"
documentclass: ctexart
output:
  pdf_document:
    fig_caption: yes
    latex_engine: xelatex
    number_sections: yes
    template: !expr rticles::ctex_template()
    toc: yes
classoption: "hyperref`r if (.Platform$OS.type != 'windows') ',nofonts'`"
---

```{r include=FALSE}
library(TrialSize)
```

样本容量过小，信息不充分，所得指标不够稳定，抽样误差较大，结论的可靠性差，用于推断总体的精度差，检验效能低，会导致总体中存在的差异未能检验出来，出现假阴性的结果。样本容量过大，花费的人力、物力、财力和时间较大，还会增加工作中质量控制的难度，样本量过大还可能引入更多的混杂因素，对研究结果产生不良影响。常见样本容量的影响因素如下1.第一类错误的大小$\alpha$(或置信度为$1-\alpha$)，$\alpha$越小所需的样本容量越大。2.第二类错误的大小$\beta$，$\beta$越小，检验效能$1-\beta$越大，所需的样本量也越大，一般要求检验效能不低于0.8。在参数估计的样本容量估计中不设计$\beta$。3.容许误差d，是指研究者要求的或者客观存在的样本统计量和总体参数间或样本统计量间的差值，或专业上认为有意义的最小差值，容许误差越小，所需样本两越大。4.总体标准差s或者总体率p，常根据预实验以及既往资料进行估计，其值越大或远离0.5时，所需样本量越大。
随机对照临床试验（randomized clinical trial，RCT）是临床试验中比较重要的试验，根据设计方案，常分为平行设计、交叉设计、析因设计和序贯设计。除序贯设计不需事先估计样本含量外，其余设计均需要估计样本含量。(1) 平行设计(parallel design)：将研究对象随机分配到两组（或多组），分别接受不同的处理，两组同时开始进行研究，同时分析和比较研究结果。平行设计的双盲随机对照试验是临床试验的金标准。(2) 交叉设计（cross-over design）四队两组受试者使用两种不同的处理措施，然后将处理措施相互交换，最后将结果进行对比分析的方法。这种设计比平行设计检验效率更高，所需样本量也少。但第一阶段干预效应可能会对第二阶段有影响，产生遗留效应或其他交互效应，设计和分析比较复杂。还存在试验周期较长等不足。(3)析因设计（factorial design）是将两个或多个以上的处理因素的各水平进行组合，对各种可能的组合都进行实验，用以评价不同处理的单独作用和联合应用的交互效应。析因设计可以分析处理交互因素，但设计和分析也比较复杂。(4)序贯设计(sequential design)在试验前不规定样本，按照先后顺序用随机化方法分配进入实验组或对照组，每试验一个或一对受试者后，及时进行分析，一旦可以判定结果，即可停止试验。序贯设计符合临床患者陆续就医的实际，比较适合以单一指标做为结论依据的新药和老药或新药和安慰剂的配对比较，节省人力物力，但不适用于慢性病、多变量、长期随访等研究设计。

由于显著性检验（significance test）只能推断样本所代表的总体是否来自同一总体，不能评价差异的大小和方向，也不能说明差异是否有实际意义，出现了优效试验、非劣效试验和等效试验。$\Delta$ 为判断界值，如果治疗差异，试验药的疗效-对照药的疗效>$\Delta$ ,则认为试验药好。如果治疗差异，试验药的疗效-对照药的疗效<$\Delta$ ,则认为对照药好。
(1)非劣效性试验（noninferiority test）是要显示试验药的效应在临床意义上不差于对照药。无效假设$H_{0}$: A药疗效-B药疗效 $\leqslant $ -$\Delta$ 备择假设$H_{1}$: A药疗效-B药疗效 $> $ -$\Delta$ (2)优效性试验（superiority test）是要显示试验药是否优于对照。无效假设$H_{0}$: A药疗效-B药疗效 $\leqslant $ $\Delta$ 备择假设$H_{1}$: A药疗效-B药疗效 $>$ $\Delta$。(3) 等效性检验(equivalence test)是要显示试验药和对照药的差异在临床上并无重要性。无效假设$H_{0}$: A药疗效-B药疗效 $\leqslant $ -$\Delta$ 备择假设$H_{1}$: -$\Delta$ $<$A药疗效-B药疗效 $<$ $\Delta$ 

##均数比较的样本量估计
###单组设计
####显著性性检验
当总体方差为$sigma ^{2}$,检验功效为$1-\beta$，置信度为$1-\alpha$,最大容许误差为$\epsilon$,样本容量为$n= \frac{(z_{\alpha/2}+z_{\beta})^{2}\sigma ^{2}}{\epsilon ^{2}}$

例1 已知北京某社区50~70岁男性的平均收缩压为158mmHg，标准差为18mmHg。用某新型药品治疗后，如果平均收缩压下降10mmHg则认为有临床意义，在$\alpha=0.05$,$\beta=0.1$，问需要多大的样本容量？
```{r}
OneSampleMean.Equality(0.05,0.1,18,10)
```
当总体方差未知检验功效为$1-\beta$，置信度为$1-\alpha$,最大容许误差为$\epsilon$,样本容量为$n= \frac{(t_{\alpha/2}+t_{\beta})^{2}\sigma ^{2}}{\epsilon ^{2}}$

例2 假设例1总体方差未知，样本标准差为18mmol/L，问需要多大的样本容量？
```{r}
OneSampleMean.Equality2 <- function(alpha, beta, sigma, margin,m=1000)
{
  t0<-qt(alpha/2,m,lower.tail=FALSE)+qt(beta,m,lower.tail=FALSE)
  n0 <- (t0*sigma/margin)^2
  t1 <- qt(alpha/2,n0,lower.tail=FALSE)+qt(beta,n0,lower.tail=FALSE)
  n1<-(t1*sigma/margin)^2
  while(abs(n1-n0)>0.5){
    n0<-((qt(alpha/2,n1,lower.tail=FALSE)+qt(beta,n1,lower.tail=FALSE))*sigma/margin)^2
    n1<-((qt(alpha/2,n0,lower.tail=FALSE)+qt(beta,n0,lower.tail=FALSE))*sigma/margin)^2
  }
  n1
}

OneSampleMean.Equality2(0.05,0.1,18,10)
```

####非劣效/优效性检验
当总体方差为$sigma ^{2}$,检验功效为$1-\beta$，置信度为$1-\alpha$,最大容许误差为$\epsilon$，$\delta$具有临床意义的高限或低限,样本容量为$n= \frac{(z_{\alpha}+z_{\beta})^{2}\sigma ^{2}}{(\epsilon -\delta ) ^{2}}$

例3 一项临床试验研究新型降压药治疗高血压的作用，对北京某社区50~70岁平均收缩压为158mmHg，标准差为18mmHg的男性进行治疗，进行非劣性设计。如果新型降压药能够平均降低收缩压10mmHg，则认为有临床价值，估计新型降压药降低收缩压8mmHg,在$\alpha=0.05$,$\beta=0.1$，问需要多大的样本容量？
```{r}
OneSampleMean.NIS(0.05,0.1,18,8,10)
```
####等效性检验
当总体方差为$sigma ^{2}$,检验功效为$1-\beta$，置信度为$1-\alpha$,最大容许误差为$\epsilon$，$\delta$具有临床意义的高限或低限,样本容量为$n= \frac{(z_{\alpha}+z_{\beta/2})^{2}\sigma ^{2}}{(\delta -|\epsilon|) ^{2}}$

例4 一项临床试验研究新型降压药治疗高血压的作用，对北京某社区50~70岁平均收缩压为158mmHg，标准差为18mmHg的男性进行治疗，进行等效性检验。如果新型降压药能够平均降低收缩压10mmHg，则认为有临床价值，估计新型降压药降低收缩压8mmHg,在$\alpha=0.05$,$\beta=0.1$，问需要多大的样本容量？
```{r}
OneSampleMean.Equivalence(0.05,0.1,18,8,10)
```

###两组设计(平行)
####显著性性检验
当总体方差为$sigma ^{2}$,检验功效为$1-\beta$，置信度为$1-\alpha$,最大容许误差为$\epsilon$,样本容量为$n= \frac{(z_{\alpha/2}+z_{\beta})^{2}\sigma ^{2}(1+1/k)}{\epsilon ^{2}}$，k为实验组/对照组即$k=\frac{n_{t}}{n_{c}}$。

例5 一项临床试验研究新型降压药治疗高血压的作用，和洛丁新进行对照。如果新型降压药能够比洛丁新平均多降低收缩压10mmHg，则认为有价值。估计洛丁新降低收缩压的标准差为8mmHg，新型药品降低收缩压的标准差为15mmHg，1:1平行对照设计，在$\alpha=0.05$,$\beta=0.1$，问需要多大的样本容量？

```{r}
n <- TwoSampleMean.Equality(0.05,0.1,17,1,10) #17^2=8^2+15^2
n
```

####非劣效/优效性检验
当总体方差为$sigma ^{2}$,检验功效为$1-\beta$，置信度为$1-\alpha$,最大容许误差为$\epsilon$,样本容量为$n= \frac{(z_{\alpha/2}+z_{\beta})^{2}\sigma ^{2}(1+1/k)}{(\epsilon-\delta)^{2}}$，k为实验组/对照组即$k=\frac{n_{t}}{n_{c}}$。

例6 一项临床试验研究新型降压药治疗高血压的作用，和洛丁新进行对照,进行非劣性设计。如果新型降压药能够比洛丁新平均多降低收缩压10mmHg，则认为有价值。估计洛丁新降低收缩压的标准差为8mmHg，新型药品降低收缩压的标准差为15mmHg,新型药品与洛丁新降压能力相差5mmHg，1:1平行对照设计，在$\alpha=0.05$,$\beta=0.1$，问需要多大的样本容量？ 非劣性试验delta为负值。

```{r}
n <- TwoSampleMean.NIS(0.05,0.1,17,1,-10,5)
n
```

####等效性检验
当总体方差为$sigma ^{2}$,检验功效为$1-\beta$，置信度为$1-\alpha$,最大容许误差为$\epsilon$,样本容量为$n= \frac{(z_{\alpha/2}+z_{\beta})^{2}\sigma ^{2}(1+1/k)}{(\epsilon-|\delta|)^{2}}$，k为实验组/对照组即$k=\frac{n_{t}}{n_{c}}$。

例7 一项临床试验研究新型降压药治疗高血压的作用，和洛丁新进行对照,进行等效性设计。如果新型降压药能够比洛丁新平均多降低收缩压10mmHg，则认为有价值。估计洛丁新降低收缩压的标准差为8mmHg，新型药品降低收缩压的标准差为15mmHg,新型药品与洛丁新降压能力相差5mmHg，1:1平行对照设计，在$\alpha=0.05$,$\beta=0.1$，问需要多大的样本容量？

```{r}
n <- TwoSampleMean.Equivalence(0.05,0.1,17,1,10,5)
n
```

##率比较的样本量估计
###单组设计
####显著性检验
当总体率为$p$,检验功效为$1-\beta$，置信度为$1-\alpha$,最大容许误差为$\epsilon$,样本容量为$n=\frac{(z_{\alpha /2}+z_{\beta })^{2}p(1-p)}{\epsilon ^{2}}$。

例8 通常有50%的肿瘤患者可从抗肿瘤药物中受益，如果治疗后的受益率达30%则认为有临床价值，在$\alpha=0.05$,$\beta=0.2$，问需要多大的样本容量？
```{r}
OneSampleProportion.Equality(0.05,0.2,0.5,0.2)  #此处0.2=0.5-0.3
```
####非劣效/优效性检验
当总体率为$p$,检验功效为$1-\beta$，置信度为$1-\alpha$,最大容许误差为$\epsilon$,样本容量为$n=\frac{(z_{\alpha /2}+z_{\beta })^{2}p(1-p)}{(\epsilon-\delta ) ^{2}}$。

例9 通常有50%的肿瘤患者可从抗肿瘤药物中受益，如果治疗后的受益率达30%则认为有临床价值，治疗后的受益率比其他药物高10%则认为有推广价值，进行非劣性设计在$\alpha=0.05$,$\beta=0.2$，问需要多大的样本容量？
```{r}
OneSampleProportion.NIS(0.05,0.2,0.5,-0.1,0.2)
```
####等效性检验
当总体率为$p$,检验功效为$1-\beta$，置信度为$1-\alpha$,最大容许误差为$\epsilon$,样本容量为$n=\frac{(z_{\alpha /2}+z_{\beta })^{2}p(1-p)}{(\epsilon-\delta ) ^{2}}$。

例9 通常有50%的肿瘤患者可从抗肿瘤药物中受益，如果治疗后的受益率达30%则认为有临床价值，治疗后的受益率比其他药物高10%则认为有推广价值，进行等效性设计在$\alpha=0.05$,$\beta=0.2$，问需要多大的样本容量？
```{r}
OneSampleProportion.Equivalence(0.05,0.2,0.5,0.1,0.2)
```

###两组设计(平行设计)
####显著性检验
$p_{1}$为第一组的率，$p_{2}$为第二组的率，最大容许误差为$\epsilon$，样本容量为$n_{2}=\frac{(z_{\alpha /2}+z_{\beta })^{2}}{\epsilon ^{2}}[\frac{p_{1}(1-p_{1})}{k}+p_{2}(1-p_{2})]$,$n_{1}= kn_{2}$
例10 一个新的抗肿瘤药与安慰剂进行平行对照试验，已知10%的肿瘤患者可从安慰剂中受益，20%的肿瘤患者从新型肿瘤药品中受益，如果认为高于安慰剂10%的患者可受益即具有临床价值，进行等效性设计在$\alpha=0.05$,$\beta=0.2$，问需要多大的样本容量？
```{r}
TwoSampleProportion.Equality(0.05,0.2,0.2,0.1,1,0.1)
```

####非劣效/优效性检验
$p_{1}$为第一组的率，$p_{2}$为第二组的率，最大容许误差为$\epsilon$，样本容量为$n_{2}=\frac{(z_{\alpha}+z_{\beta })^{2}}{(\epsilon-\delta ) ^{2}}[\frac{p_{1}(1-p_{1})}{k}+p_{2}(1-p_{2})]$,$n_{1}= kn_{2}$
例11 一个新的抗肿瘤药与安慰剂进行平行对照试验，已知10%的肿瘤患者可从安慰剂中受益，20%的肿瘤患者从新型肿瘤药品中受益，如果认为高于安慰剂10%的患者可受益即具有临床价值，进行非劣效设计在$\alpha=0.05$,$\beta=0.2$，非劣性低限为5%，问需要多大的样本容量？

```{r}
TwoSampleProportion.NIS(0.05,0.2,0.2,0.1,1,-0.05,0.1) 
```

####等效性检验
$p_{1}$为第一组的率，$p_{2}$为第二组的率，最大容许误差为$\epsilon$，样本容量为$n_{2}=\frac{(z_{\alpha}+z_{\beta })^{2}}{(\delta- \epsilon) ^{2}}[\frac{p_{1}(1-p_{1})}{k}+p_{2}(1-p_{2})]$,$n_{1}= kn_{2}$
例11 一个新的抗肿瘤药与安慰剂进行平行对照试验，已知10%的肿瘤患者可从安慰剂中受益，20%的肿瘤患者从新型肿瘤药品中受益，如果认为高于安慰剂10%的患者可受益即具有临床价值，进行等效效设计在$\alpha=0.05$,$\beta=0.2$，等效性低限为5%，问需要多大的样本容量？

```{r}
TwoSampleProportion.Equivalence(0.05,0.2,0.2,0.1,1,0.05,0.1)
```

