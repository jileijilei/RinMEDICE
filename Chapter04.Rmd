---
title: "样本容量估计"
author: "梁雪枫"
date: "2014年11月18日"
documentclass: ctexart
output:
  pdf_document:
    fig_caption: yes
    latex_engine: xelatex
    number_sections: yes
    template: !expr rticles::ctex_template()
    toc: yes
classoption: "hyperref`r if (.Platform$OS.type != 'windows') ',nofonts'`"
---

```{r include=FALSE}
library(TrialSize)
library(Sample.Size)
library(samplesize4surveys)
library(SampleSizeMeans)
library(SampleSizeProportions)
```

样本容量过小，信息不充分，所得指标不够稳定，抽样误差较大，结论的可靠性差，用于推断总体的精度差，检验效能低，会导致总体中存在的差异未能检验出来，出现假阴性的结果。样本容量过大，花费的人力、物力、财力和时间较大，还会增加工作中质量控制的难度，样本量过大还可能引入更多的混杂因素，对研究结果产生不良影响。常见样本容量的影响因素如下1.第一类错误的大小$\alpha$(或置信度为$1-\alpha$)，$\alpha$越小所需的样本容量越大。2.第二类错误的大小$\beta$，$\beta$越小，检验效能$1-\beta$越大，所需的样本量也越大，一般要求检验效能不低于0.8。在参数估计的样本容量估计中不设计$\beta$。3.容许误差d，是指研究者要求的或者客观存在的样本统计量和总体参数间或样本统计量间的差值，或专业上认为有意义的最小差值，容许误差越小，所需样本两越大。4.总体标准差s或者总体率p，常根据预实验以及既往资料进行估计，其值越大或远离0.5时，所需样本量越大。通常在抽样调查和临床试验的设计中，需要估算样本含量以保证结果的可靠。

临床研究的目的不同 ,所采用的样本含量估算方法也不同。 在临床试验过程 ,需要区分是做显著性检验(significance test), 还是区间假设检验(interval hypotheses test)。显著性检验 (significance test)用于推断两个样本是否来自同一总体, 它的检验假设为两组相等的零假设 ,即样本来自同一总体。 其无效假设为$H_{0}\  \mu _{T}= \mu _{P}$,备择假设为$H_{1}\  \mu _{T}\neq \mu _{P}$ ,T(test)为试验组，P(placebo)为安慰剂组。临床试验中，对于两组疗效的评价 ,显著性检验结果不能评价差别的实际大小,更不能说明差别是否有临床实际意义 ,只能说明两组的疗效是否来自不同的总体。在临床中往往是要确认新药是否不差于或相当于甚至优于标准的有效药物 ,所以通常采用非劣效/等效/优效检验。它们的检验假设不再是一个点，而是一个区间，所以又可称之为“区间假设”(interval hypothesis)或“区间检验” (interval test) 。区间假设检验包括了等效性检验(equiv alencetest)、非劣效性检验(noninferiority test)与优效性检验(superiority test)。 非劣效性试验指主要研究目的是显示对试验药的反应在临床意义上不差于（非劣于）对照药的试验,如果治疗差异（试验药的疗效-对照药的疗效）>0，则试验药的疗效较好；治疗差异<0，则对照药疗效较好；如果允许试验药疗效比对照药疗效低一定范围，仍然认为两药疗效相当，即确定$\Delta$表示临床意义上判断疗效不差所允许的最大差异值，则如果治疗差异>-$\Delta$，便是试验药非劣效于对照药，此处的$\Delta$称为非劣效试验的判断界值（margin）。非劣效试验的原假设为$H_{0}\  \mu _{T}- \mu _{S}\geqslant -\delta$,备择假设为$H_{1}\  \mu _{T}- \mu _{S}< -\delta$，S(standard)为标准组，T(test)为试验组，通常用于与已上市的有效药物或标准治疗方案进行比较以求能提供一个新的治疗选择。等效性检验指主要研究目的是要显示两种或多种处理的反应间差异的大小在临床上并无重要性的试验，通常通过显示真正的差异在临床上可以接受的等效的上下界值之间来证实其原假设为$H_{0}\  |\mu _{T}- \mu _{S}|\geqslant \delta$，备择假设为$H_{0}\  |\mu _{T}- \mu _{S}|<  \delta$为等效标准，也称界值 ) ,只有两组假设同时成立 ,才认为等效，多见于对同一活性成分的生物等效性以及血浆无法测定时的临床等效验证。优效性试验指主要研究目的是显示所研究的药物的反应优于对比制剂（阳性或安慰剂对照），优效性试验的原假设为$H_{0}\  \mu _{T}- \mu _{S}\leqslant   \delta$,备择假设为$H_{1}\  \mu _{T}- \mu _{S}>  \delta$,通常用于具有某方面优势的在新研发的试验药，一般需要与安慰剂进行优效性试验以比较其真正的疗效和安全性，来判断其上市的利益风险。如果当前已有曾经优效性试验证实的有效药物的话，还常常与其进行比较，并判定待验证药物的疗效至少不差于（非劣于）已有有效药物作为其上市的最低标准。临床试验中，(临床)界值的选择，应由研究者与统计学家共同商定，是基于统计推理及临床判断的双重考虑；若无公认界值，可参考EMEA《Guideline on the choice of the non-inferiority margin》及《Issues on the selection of non-inferiority margin in clinical trials》等文献.

随机对照临床试验（randomized clinical trial，RCT）是临床试验中比较重要的试验，根据设计方案，常分为平行设计、交叉设计、析因设计和序贯设计。除序贯设计不需事先估计样本含量外，其余设计均需要估计样本含量。(1) 平行设计(parallel design)：将研究对象随机分配到两组（或多组），分别接受不同的处理，两组同时开始进行研究，同时分析和比较研究结果。平行设计的双盲随机对照试验是临床试验的金标准。(2) 交叉设计（cross-over design）四队两组受试者使用两种不同的处理措施，然后将处理措施相互交换，最后将结果进行对比分析的方法。这种设计比平行设计检验效率更高，所需样本量也少。但第一阶段干预效应可能会对第二阶段有影响，产生遗留效应或其他交互效应，设计和分析比较复杂。还存在试验周期较长等不足。(3)析因设计（factorial design）是将两个或多个以上的处理因素的各水平进行组合，对各种可能的组合都进行实验，用以评价不同处理的单独作用和联合应用的交互效应。析因设计可以分析处理交互因素，但设计和分析也比较复杂。(4)序贯设计(sequential design)在试验前不规定样本，按照先后顺序用随机化方法分配进入实验组或对照组，每试验一个或一对受试者后，及时进行分析，一旦可以判定结果，即可停止试验。序贯设计符合临床患者陆续就医的实际，比较适合以单一指标做为结论依据的新药和老药或新药和安慰剂的配对比较，节省人力物力，但不适用于慢性病、多变量、长期随访等研究设计。

##均数比较的样本量估计
###单组设计
####显著性性检验
当总体方差为$\sigma^{2}$,检验功效为$1-\beta$，置信度为$1-\alpha$,差值（样本均值与某参考值的差值,或者，在配对设计中，配对个体观察值之差的均数，或试验组终点与基线之差的均数）为$\epsilon$,样本容量为$n= \frac{(z_{\alpha/2}+z_{\beta})^{2}\sigma ^{2}}{\epsilon ^{2}}$

例1 已知某社区50~70岁男性的平均收缩压为158mmHg，标准差为18mmHg。用某新型药品治疗后，差值为10mmHg，在$\alpha=0.05$,$\beta=0.1$，问需要多大的样本容量？
```{r}
OneSampleMean.Equality(0.05,0.1,18,10)
```
当总体方差未知检验功效为$1-\beta$，置信度为$1-\alpha$,差值为$\epsilon$,样本容量为$n= \frac{(t_{\alpha/2}+t_{\beta})^{2}\sigma ^{2}}{\epsilon ^{2}}$

例2 已知某社区50~70岁男性的平均收缩压总体方差未知，样本标准差为18mmHg，用某新型药品治疗后，差值为10mmHg，在$\alpha=0.05$,$\beta=0.1$，问需要多大的样本容量？
总体方差未知的情况下，一般采用t分布代替z分布。使用t分布时，假设了初始值，采用迭代算法。
```{r}
OneSampleMean.Equality2 <- function(alpha, beta, sigma, margin,m=1000)
{
  t0<-qt(alpha/2,m,lower.tail=FALSE)+qt(beta,m,lower.tail=FALSE)
  n0 <- (t0*sigma/margin)^2
  t1 <- qt(alpha/2,n0,lower.tail=FALSE)+qt(beta,n0,lower.tail=FALSE)
  n1<-(t1*sigma/margin)^2
  while(abs(n1-n0)>0.5){
    n0<-((qt(alpha/2,n1,lower.tail=FALSE)+qt(beta,n1,lower.tail=FALSE))*sigma/margin)^2
    n1<-((qt(alpha/2,n0,lower.tail=FALSE)+qt(beta,n0,lower.tail=FALSE))*sigma/margin)^2
  }
  n1
}

OneSampleMean.Equality2(0.05,0.1,18,10)
```

####非劣效/优效性检验
当总体方差为$\sigma ^{2}$,检验功效为$1-\beta$，置信度为$1-\alpha$,差值为$\epsilon$，$\delta$具有临床意义的界值,进行非劣效性检验，界值应为负值，若进行优效性检验，界值为正值。样本容量为$n= \frac{(z_{\alpha}+z_{\beta})^{2}\sigma ^{2}}{(\epsilon -\delta ) ^{2}}$

例3 一项临床试验研究新型降压药治疗高血压的作用，对某社区50~70岁平均收缩压为158mmHg，标准差为18mmHg的男性进行治疗，进行非劣性设计。如果认为有临床价值界值为10mmHg，差值为8mmHg,在$\alpha=0.05$,$\beta=0.1$，问需要多大的样本容量？
```{r}
OneSampleMean.NIS(0.05,0.1,18,8,-10)
```
####等效性检验
当总体方差为$\sigma ^{2}$,检验功效为$1-\beta$，置信度为$1-\alpha$,差值为$\epsilon$，$\delta$具有临床意义的界值,样本容量为$n= \frac{(z_{\alpha}+z_{\beta/2})^{2}\sigma ^{2}}{(\delta -|\epsilon|) ^{2}}$

例4 一项临床试验研究新型降压药治疗高血压的作用，对北京某社区50~70岁平均收缩压为158mmHg，标准差为18mmHg的男性进行治疗，进行等效性检验。如果认为有临床价值界值为10mmHg，差值为8mmHg,在$\alpha=0.05$,$\beta=0.1$，问需要多大的样本容量？
```{r}
OneSampleMean.Equivalence(0.05,0.1,18,8,10)
```

###两组设计(平行)
####显著性性检验
当总体方差为$\sigma ^{2}$,检验功效为$1-\beta$，置信度为$1-\alpha$,差值为$\epsilon$,样本容量为$n_{c}= \frac{(z_{\alpha/2}+z_{\beta})^{2}\sigma ^{2}(1+1/k)}{\epsilon ^{2}}$，$n_{t}=kn_{2}$，k为实验组/对照组即$k=\frac{n_{t}}{n_{c}}$。

例5 为研究某地正常成年男、女末稍血液的红细胞的差别，据文献报道，男性红细胞均数为465万/mm3 ，女性红细胞均数为422万/mm3，标准差为52万/mm3，1:1平行对照设计，取双侧$\alpha=0.05$,$\beta=0.1$，问要抽查多少人才能发现男女间红细胞的差别？ 

```{r}
n <- TwoSampleMean.Equality(0.05,0.1,52,1,43) #465-422=43
n
```
每组样本量为31人。若实验组和对照组方差齐性采用Pooled合并方差(Pooled varance)计算样本量；若两组方差不齐，则使用Welch–Satterthwaite方程对自由度进行近似的方法计算样本量。

####非劣效/优效性检验
当总体方差为$\sigma ^{2}$,检验功效为$1-\beta$，置信度为$1-\alpha$,差值为$\epsilon$,样本容量为$n_{c}= \frac{(z_{\alpha/2}+z_{\beta})^{2}\sigma ^{2}(1+1/k)}{(\epsilon-\delta)^{2}}$，$n_{t}=kn_{2}$,k为实验组/对照组即$k=\frac{n_{t}}{n_{c}}$。

例6 为研究某地正常成年男、女末稍血液的红细胞的差别，据文献报道，男性红细胞均数为465万/mm3 ，女性红细胞均数为422万/mm3，标准差为52万/mm3，1:1平行对照设计，取双侧$\alpha=0.05$,$\beta=0.1$，界值为10mmHg，进行非劣性设计，要抽查多少人才能发现男女间红细胞的差别？ 

```{r}
n <- TwoSampleMean.NIS(0.05,0.1,52,1,-10,43)
n
```
每组样本量为17人。若实验组和对照组方差齐性采用Pooled合并方差(Pooled varance)计算样本量；若两组方差不齐，则使用Welch–Satterthwaite方程对自由度进行近似的方法计算样本量。

####等效性检验
当总体方差为$\sigma ^{2}$,检验功效为$1-\beta$，置信度为$1-\alpha$,差值为$\epsilon$,样本容量为$n_{c}= \frac{(z_{\alpha/2}+z_{\beta})^{2}\sigma ^{2}(1+1/k)}{(\epsilon-|\delta|)^{2}}$，$n_{t}=kn_{2}$，k为实验组/对照组即$k=\frac{n_{t}}{n_{c}}$。

例7 为研究某地正常成年男、女末稍血液的红细胞的差别，据文献报道，男性红细胞均数为465万/mm3 ，女性红细胞均数为422万/mm3，标准差为52万/mm3，1:1平行对照设计，取双侧$\alpha=0.05$,$\beta=0.1$，界值为10mmHg，进行等效性设计，要抽查多少人才能发现男女间红细胞的差别？ 

```{r}
n <- TwoSampleMean.Equivalence(0.05,0.1,52,1,10,43)
n
```
每组样本量为53人。若实验组和对照组方差齐性采用Pooled合并方差(Pooled varance)计算样本量；若两组方差不齐，则使用Welch–Satterthwaite方程对自由度进行近似的方法计算样本量。

###两组设计(交叉)
####显著性性检验
当总体方差为$\sigma ^{2}$,检验功效为$1-\beta$，置信度为$1-\alpha$,差值为$\epsilon$,样本容量为$n=\frac{(z_{\alpha/2}+z_{\beta})^{2}\sigma ^{2}_{m}}{2\epsilon ^{2}}$。

例8 AAA 药品和对照药品治疗高血压，患者先服用对照药品 1 个月，洗脱
2 周，再服用 AAA 1 个月，另一组反之。如果 AAA 能够比对照药品平均多降低
收缩压 5mmHg（差值），则认为有推广价值。预试验差值标准差为 10。选用 α=0.05,
Power=90%, 双侧显著性性检验，需要多少样本含量? 

```{r}
TwoSampleCrossOver.Equality(0.05,0.1,10,5)
```


##率比较的样本量估计
###单组设计
####显著性检验
当总体率为$p$,检验功效为$1-\beta$，置信度为$1-\alpha$,最大容许误差为$\epsilon$,样本容量为$n=\frac{(z_{\alpha /2}+z_{\beta })^{2}p(1-p)}{\epsilon ^{2}}$。

例8 通常有50%的肿瘤患者可从抗肿瘤药物中受益，如果治疗后的受益率达30%则认为有临床价值，在$\alpha=0.05$,$\beta=0.2$，问需要多大的样本容量？
```{r}
OneSampleProportion.Equality(0.05,0.2,0.5,0.2)  #此处0.2=0.5-0.3
```
####非劣效/优效性检验
当总体率为$p$,检验功效为$1-\beta$，置信度为$1-\alpha$,最大容许误差为$\epsilon$,样本容量为$n=\frac{(z_{\alpha /2}+z_{\beta })^{2}p(1-p)}{(\epsilon-\delta ) ^{2}}$。

例9 通常有50%的肿瘤患者可从抗肿瘤药物中受益，如果治疗后的受益率达30%则认为有临床价值，治疗后的受益率比其他药物高10%则认为有推广价值，进行非劣性设计在$\alpha=0.05$,$\beta=0.2$，问需要多大的样本容量？
```{r}
OneSampleProportion.NIS(0.05,0.2,0.5,-0.1,0.2)
```
####等效性检验
当总体率为$p$,检验功效为$1-\beta$，置信度为$1-\alpha$,最大容许误差为$\epsilon$,样本容量为$n=\frac{(z_{\alpha /2}+z_{\beta })^{2}p(1-p)}{(\epsilon-\delta ) ^{2}}$。

例9 通常有50%的肿瘤患者可从抗肿瘤药物中受益，如果治疗后的受益率达30%则认为有临床价值，治疗后的受益率比其他药物高10%则认为有推广价值，进行等效性设计在$\alpha=0.05$,$\beta=0.2$，问需要多大的样本容量？
```{r}
OneSampleProportion.Equivalence(0.05,0.2,0.5,0.1,0.2)
```

###两组设计(平行设计)
####显著性检验
$p_{1}$为第一组的率，$p_{2}$为第二组的率，最大容许误差为$\epsilon$，样本容量为$n_{2}=\frac{(z_{\alpha /2}+z_{\beta })^{2}}{\epsilon ^{2}}[\frac{p_{1}(1-p_{1})}{k}+p_{2}(1-p_{2})]$,$n_{1}= kn_{2}$
例10 一个新的抗肿瘤药与安慰剂进行平行对照试验，已知10%的肿瘤患者可从安慰剂中受益，20%的肿瘤患者从新型肿瘤药品中受益，如果认为高于安慰剂10%的患者可受益即具有临床价值，进行等效性设计在$\alpha=0.05$,$\beta=0.2$，问需要多大的样本容量？
```{r}
TwoSampleProportion.Equality(0.05,0.2,0.2,0.1,1,0.1)
```

####非劣效/优效性检验
$p_{1}$为第一组的率，$p_{2}$为第二组的率，最大容许误差为$\epsilon$，样本容量为$n_{2}=\frac{(z_{\alpha}+z_{\beta })^{2}}{(\epsilon-\delta ) ^{2}}[\frac{p_{1}(1-p_{1})}{k}+p_{2}(1-p_{2})]$,$n_{1}= kn_{2}$
例11 一个新的抗肿瘤药与安慰剂进行平行对照试验，已知10%的肿瘤患者可从安慰剂中受益，20%的肿瘤患者从新型肿瘤药品中受益，如果认为高于安慰剂10%的患者可受益即具有临床价值，进行非劣效设计在$\alpha=0.05$,$\beta=0.2$，非劣性低限为5%，问需要多大的样本容量？

```{r}
TwoSampleProportion.NIS(0.05,0.2,0.2,0.1,1,-0.05,0.1) 
```

####等效性检验
$p_{1}$为第一组的率，$p_{2}$为第二组的率，最大容许误差为$\epsilon$，样本容量为$n_{2}=\frac{(z_{\alpha}+z_{\beta })^{2}}{(\delta- \epsilon) ^{2}}[\frac{p_{1}(1-p_{1})}{k}+p_{2}(1-p_{2})]$,$n_{1}= kn_{2}$
例11 一个新的抗肿瘤药与安慰剂进行平行对照试验，已知10%的肿瘤患者可从安慰剂中受益，20%的肿瘤患者从新型肿瘤药品中受益，如果认为高于安慰剂10%的患者可受益即具有临床价值，进行等效效设计在$\alpha=0.05$,$\beta=0.2$，等效性低限为5%，问需要多大的样本容量？

```{r}
TwoSampleProportion.Equivalence(0.05,0.2,0.2,0.1,1,0.05,0.1)
```

