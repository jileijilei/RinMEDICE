---
title: "假设检验"
author: "梁雪枫"
date: "2014年11月18日"
documentclass: ctexart
output:
  pdf_document:
    fig_caption: yes
    latex_engine: xelatex                               
    number_sections: yes
    template: !expr rticles::ctex_template()
    toc: yes
classoption: "hyperref`r if (.Platform$OS.type != 'windows') ',nofonts'`"
---

```{r include=FALSE}
library(TrialSize)
```

假设检验（hypothesis test），就是根据已掌握的资料对一个总体参数是否等于某一个数值，某一随机变量是否服从某种概率分布的假设，然后根据所取得的样本资料，利用一定的统计方法计算出有关检验的统计量，依据一定的概率原则，以较小的风险来判断估计数值与总体数值（或估计分布与实际分布）是否存在显著差异，是否应当接受原假设的一种检验方法。假设检验是根据小概率事件的实际不可能性原理来推断的。假设检验中的小概率标准称为显著性水平，用$\alpha$表示。依据显著性水平的大小将检验统计量的所有可能值组成的样本空间分为两个区域 ：否定域或拒绝域：在原假设成立的情况下，如果检验统计量的值落在这个区域里，则否定原假设。接受域：在原假设成立的情况下，如果检验统计量的值没有落在这个区域里，则接受原假设。 假设检验的步骤:1. 建立统计假设,包括原假设,备择假设。2. 确立合适的检验统计量，确定其分布。3. 规定显著性水平 4. 根据样本观测值计算检验，统计量的取值。5. 判断原假设是否成立。假设检验的四种情况

                          $H_{0}$为真         $H_{0}$为假 
---                      ---                  --- 
接受$H_{0}$              正确决策              第二类错误 $\beta$
拒绝$H_{0}$              第一类错误$\alpha$    正确决策 

第一类错误，也称弃真错误,本来是真的，却根据检验统计量的值把它给否定了。发生这种错误的概率通常用$\alpha$表示。第二类错误，也称取伪错误，本来是假的，却根据检验统计量的值把它给接受了。

##参数假设检验
参数假设检验，是指在总体的分布形式已知的条件下，对总体参数的某一假设进行的检验 。
###正态总体均值的假设检验
####单个总体的情况及实例
当总体分布为正态分布，总体标准差为已知时，检验所使用的检验统计量为$z=\frac{\bar{x}-\mu _{0}}{\sigma _{0}/\sqrt{n}}\sim N(0,1)$。$\sigma$为总体方差，$\mu _{0}$为总体均数，$n$为样本数，$\bar{x}$为样本均数。
在总体方差未知的情况下，用样本方差$S$代替总体$\sigma$,检验统计量为$t=\frac{\bar{x}-\mu _{0}}{S/\sqrt{n}}\sim t(n-1)$

例1 某药厂生产一批新的药品，规定直径为10mm,方差为0.4。为了检验机器的性能是否良好，随机抽取了25件产品，测得其平均长度为9.30  9.32 10.41  9.06 10.21  9.31  9.96  9.03 10.22  9.19 10.36  9.67 10.43 10.36  9.83 10.67 10.38 9.29  9.74  9.99  9.98  9.89  9.52  9.88  9.67。假设生产的药品直径服从正态分布，问在显著性水平0.05时，该机器的性能是否良好。
```{r}
z.test<-function(x,sigma,alpha,u0=0,alternative="two.sided"){
  n <- length(x)
  options(digits=4)
  result<-list( )
  mean<-mean(x)
  z<-(mean-u0)/(sigma/sqrt(n))
  p<-pnorm(z,lower.tail=FALSE)
  result$mean<-mean
  result$z<-z
  result$p.value<-p
  if(alternative=="two.sided"){
    p<-2*p
    result$p.value<-p
  }
  else if (alternative == "greater"|alternative =="less" ){
    result$p.value<-p
  }
  else return("your input is wrong")
  result$conf.int<- c(
    mean-sigma*qnorm(1-alpha/2,mean=0, sd=1,
                     lower.tail = TRUE)/sqrt(n),
    mean+sigma*qnorm(1-alpha/2,mean=0, sd=1,
                     lower.tail = TRUE)/sqrt(n))
  result
}

x <- c(9.30,9.32,10.41,9.06,10.21,9.31,9.96,9.03,10.22,9.19,10.36,9.67,10.43,10.36,9.83,10.67,10.38,9.29,9.74,9.99,9.98,9.89,9.52,9.88,9.67)

z.test(x,0.4,0.05,10)

```

例2 假设例1的总体方差未知，假设生产的药品直径服从正态分布，问在显著性水平0.05时，该机器的性能是否良好。
```{r}
t.test(x,alternative = "two.sided",mu=10)
```

####两个总体的情况及实例
两个总体为正态分布，方差已知,检验所使用的检验统计量为$z=\frac{(x_{1}-x_{2})-(u_{1}-u_{2})}{\sqrt{\frac{\sigma_{1}^{2}}{n_{1}}+\frac{\sigma_{1}^{2}}{n_{2}}}}\sim N(0,1)$

两个总体为正态分布，方差未知,检验所使用的检验统计量为$T=\frac{(x_{1}-x_{2})-(u_{1}-u_{2})}{\sqrt{\frac{S^{2}}{n_{1}}+\frac{S^{2}}{n_{2}}}}\sim t(n_{1}+n_{2}-2)$

例3 制药厂试制某种安定神经的新药，两台仪器制造药品服从正态分布，从各自加工药品中，分别取若干个测量其直径，两组直径如下A组 20.5 19.8 19.7 20.4 20.1 20.0 19.0 19.9 B组 20.7 19.8 19.5 20.8 20.4 19.6 20.2，问两台仪器的加工精度有无显著差异？
```{r}
x<-c(20.5, 19.8, 19.7, 20.4, 20.1, 20.0, 19.0, 19.9)
y<-c(20.7, 19.8, 19.5, 20.8, 20.4, 19.6, 20.2)

t.test(x, y, var.equal=TRUE)
```

###总体比例的假设检验
####单样本率的检验
样本率与总体率比较的目的，是推断该样本所代表的未知总体率π与已知总体率$\hat{p}$ 是否不同。 当样本含量$n$足够大，且样本率$p_{0}$ 和$1-p_{0}$均不太小，如 $np_{0}$与$n(1-p_{0})$均大于5 时，样本率的分布近似正态分布统计量$Z=\frac{\hat{p}-p_{0}}{\sqrt{p_{0}(1-p_{0})}}\sim N(0,1)$。当$np_{0}$与$n(1-p_{0})$均小于5时，样本率的分布近似二项分布。

例4 按照以往经验，新生儿染色体异常率一般为1%，某医院观察了当地400名新生儿，有一例染色体异常，问该地区新生儿染色体是否低于一般水平？

```{r}
binom.test(1,400,p=0.01,alternative="less")

#样本量较小时，不宜选择prop.test(),有警告！
prop.test(1,400,p=0.01,alternative="less")
```
P值大于0.05，尚不能认为该地区新生儿染色体异常低于一般水平。

####两样本率的检验
两个总体比例$hat{p_{1}}$和$hat{p_{1}}$的极大似然估计分别为近似地服从正态分布:
  $Z=\frac{\hat{p_{1}}-\hat{p_{2}}}{\sqrt{(n_{1}+n_{2})\hat{p}(1-\hat{p})/n_{1}n_{2}}}$,$\hat{p}=\frac{n_{1}\hat{p_{1}}+n_{2}\hat{p_{2}}}{n_{1}+n_{2}}$
  
例5 某综合医院随机抽取了345个男病例与451个女性病例调查吸烟的暴露情况, 调查结果为187个男性病例与76女性病例中有吸烟的暴露, 能否认为男、女病例吸烟的暴漏一致?

```{r}
s <- c(187,76)
t <- c(345,451)
prop.test(s,t)
```
P值较小，可以认为男女病例的吸烟暴漏情况不同。

##非参数假设检验
非参数假设检验，是指在总体分布未知时，对其分布的具体形式、特征值等信息进行的假设检验。
###Pearson拟合优度$\chi ^{2}$检验
假定某随机变量$X$应当有分布，对$X$进行$n$次观察，可以得到Pearson$\chi^{2}$统计量$K=\sum_{i=1}^{m}\frac{(n_{i}-np{i})^{2}}{np_{i}}$,当$n\rightarrow \infty$时，$K$分布收敛于自由度为$m-1$的$\chi ^{2}$分布。$m$为区间个数，$n_{i}$为随机变量落在区间内的个数，$p_{i}$为区间的理论概率。
例6 20位病人的某项临床检验值如下9.66 35.42 39.24 32.00  6.63 27.96 20.79 17.81 19.97 13.03 35.93 13.30 32.39 23.21 31.35 16.98 20.56 16.94 35.21 23.33，请用Pearson $\chi ^{2}$检验判断是否服从正态分布？

```{r}
 x <- c(9.66,35.42,39.24,32.00,6.63,27.96,20.79,17.81,19.97,13.03,35.93,13.30,32.39,23.21,31.35,16.98,20.56,16.94,35.21,23.33)
 g <- table(cut(x,breaks = c(5,10,15,20,25,30,35)))
 p <- pnorm(c(10,15,20,25,30,35),mean(x),sd(x))
 p <- c(p[1],p[2]-p[1],p[3]-p[2],p[4]-p[3],p[5]-p[4],1-p[5])
 chisq.test(g,p = p)

```
P值大于0.05，可以认为服从正态分布
###Kolmogorov-Smirnov检验
Kolmogorov-Smirnov是比较一个频率分布f(x)与理论分布g(x)或者两个观测值分布的检验方法。其原假设$H_{0}$:两个数据分布一致或者数据符合理论分布。 $D=max|f(x)-g(x)|$,当实际观测值$D>D(n,\alpha)$则拒绝$H_{0}$，否则则接受$H_{0}$假设。检验统计量为$Z=\sqrt{n}\max_{i}(|F_{n}(x_{i-1}-F(x_{i})|,|F_{n}(x_{i}-F(x_{i})|)$。
####单样本检验
例7 20位病人的某项临床检验值如下9.66 35.42 39.24 32.00  6.63 27.96 20.79 17.81 19.97 13.03 35.93 13.30 32.39 23.21 31.35 16.98 20.56 16.94 35.21 23.33，请用Kolmogorov-Smirnov检验判断是否服从正态分布？
```{r}
x <- c(9.66,35.42,39.24,32.00,6.63,27.96,20.79,17.81,19.97,13.03,35.93,13.30,32.39,23.21,31.35,16.98,20.56,16.94,35.21,23.33)
ks.test(x,mean(x),sd(x))
```
P值大于0.05，可以认为服从正态分布
####两样本检验
例8 测定两组病人尿液中的尿胆原（URO），A组 2.13 13.91 15.65 12.34  0.74 10.49  7.22  5.86  6.84  3.67 B组 4.62  6.16 0.52  4.79 0.21  3.69  3.46  3.42  5.67  2.83，请检验A组和B组是否相同？

```{r}
a <- c(2.13,13.91,15.65,12.34,0.74,10.49,7.22,5.86,6.84,3.67)
b <- c(4.62,6.16,0.52,4.79,0.21,3.69,3.46,3.42,5.67,2.83)
ks.test(a,b)
```
P值大于0.05，可以认为A、B两组相同。

###列联表的独立性检验

```{r}
table2flat <- function(mytable){
  df <- as.data.frame(mytable)
  rows <- dim(df)[1]
  cols <- dim(df)[2]
  x <- NULL
  for(i in 1:rows){
    for(j in 1:df$Freq[i]){
      row <- df[i,c(1:(cols-1))]
      x <- rbind(x,row)
    }
  }
  row.names(x) <- c(1:dim(x)[1])
  return(x)
}

treatment <- rep(c("Placebo","Treated"),times=3)
improved <- rep(c("None","Some","Marked"),each=2)
Freq <- c(29,13,7,17,7,21)
mytable <- as.data.frame(cbind(treatment,improved,Freq))

mydata <- table2flat(mytable)
```

###符号检验
###秩相关检验
###Wilcoxon秩检验