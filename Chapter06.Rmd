---
title: "回归分析"
author: "梁雪枫"
date: "2014年12月10日"
documentclass: ctexart
output:
  pdf_document:
    fig_caption: yes
    latex_engine: xelatex
    number_sections: yes
    template: !expr rticles::ctex_template()
    toc: yes
classoption: "hyperref`r if (.Platform$OS.type != 'windows') ',nofonts'`"
---

```{r include=FALSE}
library(pander)
library(ggplot2)
library(pspearman)
library(gvlma)
```
回归分析通过建立函数表达式，用一个或者多个自变量的变化解释或预测因变量，常用于描述、探索和检验自变量和因变量之间因果关系，根据自变量的变化预测因变量的取值。通常按照自变量的个数划分为一元回归和多重回归。按照函数表达式的形式，分为线性回归和非线性回归。

##一元线性回归
假设有两个变量X和Y，X为自变量，Y为因变量。则一元线性回归模型的基本结构形式为$$Y=\beta _{0}+\beta _{1}X+\varepsilon $$。$\varepsilon$是误差项，表示未知或不易测量的随机因素对因变量影响的总和。$\beta _{0}$为回归的常数，$\beta _{1}$为回归系数，它表示增加和减少一个单位时，Y的平均变化量。线性回归就是根据已经观测到的样本数据，应用最小二乘法获得对$\beta _{0}$和$\beta _{1}$的估计，进而得到回归方程。由于参数估计时并不知道是否存在线性关系，回归方程在应用前需要完成对回归方程的检验，即对回归模型的系数是否为零进行检验。常用t检验、F检验和相关系数检验评价回归方程的回归系数是否为0。
线性回归应用有四个前提条件：线性、独立、正态和方差齐性。线性指自变量和因变量在散点图大致呈直线趋势。独立性值观察值之间应相互独立。正态性指残差应符合正态分布。方差齐性指在自变量取值范围内，对于自变量的取值，因变量都有相同的方差。

例1 某医生分别采用盐析法和结合法测定正常皮肤中胶原蛋白的含量。盐析法只能部分提纯，结合法较为复杂单精确。该医生欲寻求找盐析法和结合法之间的关系，以便通过盐析法预测结合法的测定值。

编号   
----   --- --- --- --- --- --- ---  ---  ---  ---  ---  ---  ---  ---  ---
盐析法 6.8 7.8 8.7 8.7 8.9 9.5 10.1 10.2 10.3 10.4 11.1 12.4 13.3 13.1 13.2
结合法 546 553 562 563 570 575 581  605  607  621  624  626  632  640  656

解 做散点图，观察是否存在线性关系。由于线性回归的条件（线性、正态性、方差齐性和独立性）是通过残差来完成的，可先建立回归方程，然后通过回归诊断来完成线性回归条件的检验。
线性条件可通过散点图直接观察。
```{r}
y <- c(546,553,562,563,570,575,581,605,607,621,624,626,632,640,656)
x <- c(6.8,7.8,8.7,8.7,8.9,9.5,10.1,10.2,10.3,10.4,11.1,12.4,13.3,13.1,13.2)
df <- as.data.frame(cbind(x,y))

#ggplot(df,aes(x,y))+geom_point()+stat_smooth(method = "lm")
plot(x,y)
```
通过散点图，可以发现二者近似直线关系，符合线性条件。

对数据进行线性回归分析。
```{r}
model <- lm(y~x) #~左边为响应变量，右边为各个预测变量，预测变量之间用+符号分隔
summary(model)
```
结果中Coefficients是参数估计的结果。结果显示，截距项和回归系统均有统计学意义。模型简单评价$R^{2}$为0.9017，校正决定系数$R_{adj}^{2}$为0.9841。决定系数越大表明自变量对因变量的解释程度越高。F检验检验所有的预测变量预测响应变量是否都在某个几率水平之上，结果表明(F=119.2,P=6.426e-08),方程总体有统计学意义。残差的标准误则可认为模型用自变量预测因变量的平均误差。
所建立的方程为
Y=426.625+16.580×X
对估计值做出区间估计

```{r}
confint(model)
```

```{r}
plot(df$x,df$y)
abline(model)
```
模型评价

回归诊断主要包括三方面：（1）误差项是否满足独立性、等方差性和正态性，选择模型是否合适。（2）是否存在异常样本，回归分析的结果是否对某些样本依赖过重，即回归模型是否具备稳定性。（3）自变量之间是否存在高度相关，即是否有多重共线性问题存在。

```{r}
par(mfrow=c(2,2))
plot(model) 
par(mfrow=c(1,1))
```
标准方法
正态性 当预测变量值固定时，因变量成正态颁，则残差图也应是一个均值为0的正态颁。正态Q-Q图是在正态颁对应的值上，标准化残差的概率图，若满足正态假设，则图上的点应该落在45度角的直线上，若不是，则违反了正态性假设。第二幅Normal QQ-plot图中数据点分布趋于一条直线, 说明残差是服从正态分布的。

独立性 无法从图中分辨因变量值是否相互独立，只能从收集的数据中验证。本例中适用结合法进行测量时，无理由相信一个测量结果会影响另外一次的测量。

线性 若因变量与自变量线性相关，则残差值与预测（拟合）值就没有系统关联，若存在关系，则说明可能城要对回归模型进行调整。第一幅图Residual vs fitted为拟合值y对残差的图形, 可以看出,数据点都基本均匀地分布在直线y=0的两侧, 无明显趋势，满足线性假设。

方差齐性 若满足不变方差假设，则在第三幅图位置尺度图（Scale-Location Graph）中，水平线周围的点应随机分布，Scale-Location 图显示了标准化残差(standardized residuals)的平方根的分布情况，最高点为残差最大值点。第三副图显示基本符合方差齐性的要求。

第四幅图（Residuals vs Leverage）提供了单个观测点的信息，从图中可以鉴别离群点、高高杆值点和强影响点。

改进方法

正态性 通过对残差正态性检验予以证实。
```{r}
model <- lm(y~x)
shapiro.test(residuals(model))
```
正态性检验结果表明W值为`r shapiro.test(residuals(model))$statistic`，P值为`r shapiro.test(residuals(model))$p.value`,残差符合正态分布。

独立性 判断因变量（或残差）最好的方法时依据收集数据的方式的先验知识。car包提供了Durbin-Watson检验的函数，能够检验误差序列的相关性。
```{r}
durbinWatsonTest(model)
```
本例结果P值比较显著，但根据先验知识，并不能否定因变量的独立性。

线性 可通过成分残差图(component plus residual plot)即偏残差图(partial residual plot)，判断因变量与自变量之间是否呈非线性关系，也可以看是否不同于已设定线性模型的系统偏差，图形可用car包中crPlots()函数绘制。图形存在非线性，则说明可能对预测变量的函数形式建模不够充分.
```{r}
crPlots(model) 
```
图形呈现线性，建模比较充分。

方差齐性 通过以因变量为x轴，学生化残差为y轴做残差图，进行判断。
```{r}
plot(predict(model),rstudent(model))
```
所有的学生化残差均在$\pm 2$在范围内波动，没有明显的上升或下降趋势，可以认为符合方差齐性。还通过自变量与残差绝对值的等级相关检验来判断。

```{r}
spearman.test(x,abs(residuals(model))) #R中pspearman包中的spearman.test函数可以完成斯皮尔曼等级相关检验

#cor.test(x,abs(residuals(model)),method="spearman") #或者用cor.test()
```
自变量与残差绝对值的等级相关系数为`r cor.test(x,abs(residuals(model)),method="spearman")$p.value`,P值大于0.05，无统计学意义，可以认为残差方差齐性。

car包提供了两个有用的函数，可判断误差方差是否恒定，ncvTest()函数生成一个计分检验，零假设为误差方差不变,备择假设为误差方差随着拟合值水平的变化而变化。若检验显著，择说明存在异方差性。spreadLevelPlot()函数创建一个添加了最佳拟合曲线的散点图，展示标准化残差绝对值与拟合值的关系。

```{r}
ncvTest(model)  
spreadLevelPlot(model) 
```
计分检验结果不显著，说明满足方差齐性的假设。通过水平分布图，可以看到其中的点在水平的最佳拟合曲线周围呈水平随机分布。若违反了该假设，将会呈现一个非水平的曲线。


线性模型假设的综合验证
```{r}
gvlma(model)
```
Global Stat给模型假设提供了一个单独的综合检验（通过/不通过），本例中，可以看到数据满足线性回归模型所有的统计假设（P=0.7071）。同时还对偏度(Skewness)、峰度(Kurtosis)、连接函数(Link function)和异方差性(Heteroscedasticity)进行了评价。

2.影响分析

是探查对估计有异常影响的数据，如果一个样本不服从某个模型，其余数据服从这个模型，则称该样本点为强影响点。影响分析就是区分这样的样本数据。

离群点指那些模型预测效果不佳的观测点，通常有很大的、或正或负的残差，正残差说明模型低估了响应值，负残差说明高佑了响应值。

```{r}
outlierTest(model) #Bonferroni离群点检验
qqPlot(model,labels=row.names(df),id.method = "identify",simulate=T,main="QQPlot") #car包
```
outlierTest（）函数是根据单个最大（或正或负）残差值的显著性来判断是否有离群点，若不显著，则说明数据集中没有离群点，若显著，则必须删除该离群点，然后再检验是否还有其他离群点存在。qqPlot图中落在置信区间带外的点可被认为时离群点。本例中未发现有离群点。

高杠杆值点是与其他预测变量有关的离群点，即它们是由许多异常的预测变量组合起来的，与响应变量值没有关系。
高杠杆值的观测点可通过帽子统计量（hat statistic）判断。对于一个给定的数据集，帽子均值为p/n，其中p是模型估计的参数数目（包含截距项），n是样本量。一般来说，若观测点的帽子值大于帽子均值的2或3倍，则可认定为高杠杆值点。
```{r}
 hat.plot<-function(fit){  
  p<-length(coefficients(fit))  
  n<-length(fitted(fit))  
  plot(hatvalues(fit),main="Index Plot of Hat Values")  
  abline(h=c(2,3)*p/n,col="red",lty=2)  
  identify(1:n,hatvalues(fit),names(hatvalues(fit)))  
}  
hat.plot(model) 
```
此图中可以看到1号点是高杠杆值点。

强影响点
强影响点，即对模型参数估计值影响有些比例失衡的点。例如，当移除 模型的一个观测点时模型会发生巨大的改变，那么需要检测一下数据中是否存在强影响点。Cook距离，或称为D统计量。Cook's D值大于4/(n-k-1)，则表明它是强影响点，其中n为样本量大小，k是预测变量数目（有助于鉴别强影响点，但并不提供关于这些点如何影响模型的信息）。
```{r}
plot(model,which=4)
```
Cook距离(Cook’s distance)图显示了对回归的影响点。根据Cook距离，13号点可能是个强影响点。

影响分析综合分析 
```{r}
influence.measures(model)
influencePlot(model) #car包中的influencePlot（）函数，可将离群点、杠杆点和强影响点的信息整合到一幅图形中
```
纵坐标超过2或小于-2的州可被认为是离群点，水平轴超过0.2或0.3的州有高杠杆值（通常为预测值的组合）。圆圈大小与影响成比例，圆圈很大的点可能是对模型估计造成的不成比例影响的强影响点。


3.共线性，条件数 本例只有一个自变量，不涉及。


##多重共线性


目前常用的多重共线性诊断方法
　　1.自变量的相关系数矩阵R诊断法：研究变量的两两相关分析，如果自变量间的二元相关系数值很大，则认为存在多重共线性。但无确定的标准判断相关系数的大小与共线性的关系。有时，相关系数值不大，也不能排除多重共线性的可能。
　　2.方差膨胀因子（the variance inflation factor，VIF)诊断法：方差膨胀因子表达式为：VIFi=1/（1-R2i)。其中Ri为自变量xi对其余自变量作回归分析的复相关系数。当VIFi很大时，表明自变量间存在多重共线性。该诊断方法也存在临界值不易确定的问题，在应用时须慎重。
　　3.容忍值（Tolerance，简记为Tol）法：容忍值实际上是VIF的倒数，即Tol＝1/VIF。其取值在0～1之间，Tol越接近1，说明自变量间的共线性越弱。在应用时一般先预先指定一个Tol值，容忍值小于指定值的变量不能进入方程，从而保证进入方程的变量的相关系数矩阵为非奇异阵，计算结果具有稳定性。但是，有的自变量即使通过了容忍性检验进入方程，仍可导致结果的不稳定。
　　4.多元决定系数值诊断法：假定多元回归模型p个自变量，其多元决定系数为R2y（X1，X2,…，Xp）。分别构成不含其中某个自变量（Xi,i=1,2,…，p）的p个回归模型，并应用最小二乘法准则拟合回归方程，求出它们各自的决定系数R2i（i=1,2,…，p）。如果其中最大的一个R2k与R2Y很接近，就表明该自变量在模型中对多元决定系数的影响不大，说明该变量对Y总变异的解释能力可由其他自变量代替。它很有可能是其他自变量的线性组合。因此，该自变量进入模型后就有可能引起多重共线性问题。该方法也存在临界值和主观判断问题。
　　5.条件数与特征分析法：在自变量的观测值构成的设计矩阵X中，求出变量相关系数R的特征值，如果某个特征值很小（如小于0．05 ），或所有特征值的倒数之和为自变量数目的5倍以上，表明自变量间存在多重共线性关系。利用主成分分析，如果X′X的特征值RK小于0．05时，RK所对应的主成分FK可近似为零，表明自变量间存在K个多重共线性关系。 

语言实现多重共线性的检验(基于条件数和特征分析法)
    step1: 利用kappa函数,计算自变量矩阵的条件数;
    step2: 判断是否存在多重共线性. 从实际经验的角度,一般若条件数<100,则认为多重共线性的程度很小,若100<=条件数<=1000,则认为存在中等程度的多重共线性,若条件数>1000,则认为存在严重的多重共线性.





