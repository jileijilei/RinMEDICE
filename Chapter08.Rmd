---
title: "方差分析"
author: "梁雪枫"
documentclass: ctexart
output:
  pdf_document:
    fig_caption: yes
    latex_engine: xelatex
    number_sections: yes
    template: !expr rticles::ctex_template()
    toc: yes
classoption: "hyperref`r if (.Platform$OS.type != 'windows') ',nofonts'`"
---

```{r include=FALSE}
library(car)
library(DescTools)
library(multcomp)
library(pander)
```

方差分析（analysis of variation,简写为ANOVA）又称变异数分析或F检验,用于两个及两个以上样本均值差别的显著性检验。其目的是推断两组或多组数据的总体均值是否相同，检验两个或多个样本均值的差异是否有统计学意义。方差分析的基本思路为：将试验数据的总变异分解为来源于不同因素的相应变异，并作出数量估计，从而明确各个变异因素在总变异中所占的重要程度；也就是将试验数据的总变异方差分解成各变因方差，并以其中的误差方差作为和其他变因方差比较的标准，以推断其它变因所引起的变异量是否真实的一种统计分析方法。把对试验结果发生影响和起作用的自变量称为因素（factor），即我们所要检验的对象。如果方差分析研究的是一个因素对于试验结果的影响和作用，就称为单因素方差分析。因素的不同选择方案称之为因素的水平(level of factor)或处理(treatment)。因素的水平实际上就是因素的取值或者是因素的分组。样本数据之间差异如果是由于抽样的随机性造成的，称之为随机误差；如果是由于因素水平本身不同引起的差异，称之为系统误差。

方差分析的基本前提各组的观察数据，要能够被看作是从服从正态分布的总体中随机抽得的样本。各组的观察数据，是从具有相同方差的总体中抽取得到的。观察值是相互独立的。 方差分析的原假设：$H_{0}\ \theta _{1}=\theta _{2}=...=\theta _{k}$          即因素的不同水平对实验结果没有显著差异或影响。备择假设：不是所有的$\theta _{i}$都相等$(i=1,2,...,k)$，即因素的不同水平对实验结果有显著差异或影响。

##单因素方差分析（one-way ANOVA）
单因素方差分析是指对单因素试验结果进行分析，检验因素对试验结果有无显著性影响的方法。单因素方差分析是用来检验多个平均数之间的差异，从而确定因素对试验结果有无显著性影响的一种统计方法。对于完全随机设计试验且处理数大于2时可以用单因素方差分析（等于2 时用t检验）。离差平方和的分解公式为：SST(总和)=SSR(组间)+SSE(组内)，F统计量为MSR/MSE，MSR=SSR/k-1,MSE=SSE/n-k。

例 某医院欲研究A、B、C三种降血脂药物对家兔血清肾素血管紧张素转化酶（ACE）的影响，将家兔随机分为三组，均喂以高脂饮食，分别给予不同的降血脂药物。一定时间后测定家兔血清ACE浓度（u/ml），A组（45 44 43 47 48 44 46 44 40 45 42 40 43 46 47 45 46 45 43 44），B组（45 48 47 43 46 47 48 46 43 49 46 43 47 46 47 46 45 46 44 45 46 44 43 42 45），c组（47 48 45 46 46 44 45 48 49 50 49 48 47 44 45 46 45 43 44 45 46 43 42），问三组组家兔血清ACE浓度是否相同？

```{r}
a <- c(45, 44, 43, 47, 48, 44, 46, 44, 40, 45, 42, 40, 43, 46, 47, 45, 46, 45, 43, 44)
b <- c(45, 48, 47, 43, 46, 47, 48, 46, 43, 49, 46, 43, 47, 46, 47, 46, 45, 46, 44, 45, 46, 44, 43, 42, 45)
c <- c(47, 48, 45, 46, 46, 44, 45, 48, 49, 50, 49, 48, 47, 44, 45, 46, 45, 43, 44, 45, 46, 43, 42)
mydata <- data.frame(length = c(a, b, c), site = factor(c(rep("1", 20), rep("2", 25), rep("3", 23))))

boxplot(length ~ site, data = mydata, xlab = "Sites", ylab = "Length")
model=aov(length ~ site, data = mydata)
summary(model)
```
箱形图中可观察到不同的因素对于因变量的影响。用aov函数建立单因子方差模型，从结果的P值可看到各组均值有显著不同。单因子方差分析结果显示F value = 3.24 ，Pr(>F) = 0.045，因此拒绝原假设，即认为三组组家兔血清ACE浓度在统计学上有显著差异。

###假设检验
方差分析需要一定的假设，即数据集应该符合正态和同方差，分别用shapiro.test和bartlett.test检验从P值观察到这两个假设是符合的。对于不符合假设的情况，我们就要用到非参数方法，例如Kruskal-Wallis秩和检验
```{r}
shapiro.test(mydata$length)
bartlett.test(length ~ site,data = mydata)
```
正态性检验和方差齐性检验P值均大于0.05，可以认为数据满足正态性和同方差的要求。

###多重比较
方差分析只告诉我们这三组之间是不同的，但没有告诉哪两组之间有明显差别，此时需要使用TukeyHSD函数进行均值的多重比较分析，从结果中观察到有一个两两比较是不显著的。
```{r}
(result=TukeyHSD(model))
plot(result)
```
C组和A组两两比较显著。

##双因素方差分析（Two-way ANOVA）
研究两个因素的不同水平对试验结果的影响是否显著的问题就称作双因素方差分析，分别对两个因素进行检验，考察各自的作用，同时分析两个因素（因素A和因素 B）对试验结果的影响。如果因素A和因素B对试验结果的影响是相互独立的，则可以分别考察各自的影响，这种双因素方差分析称为无交互作用的双因素方差分析，也叫无重复双因素方差分析。无交互作用的双因素方差分析，相当于对每个因素分别进行单因素方差分析。如果因素A和因素B除了各自对试验结果的影响外，还产生额外的新影响，这种额外的影响称为交互作用，这时的双因素方差分析则称为有交互作用的双因素方差分析，也叫有重复双因素方差分析。可用于随机区组实验设计，用来分析两个因素的不同水平对结果是否有显著影响，以及两因素之间是否存在交互效应。SST=SSA+SSB+SSE

例 关于检验毒品强弱的试验，给48只老鼠注射I, II, III三种毒药(因素A)，同时有A, B, C, D4种治疗方案(因素B)，这样的试验在每一种因素组合下都重复四次测试老鼠的存活时间（年）。试分析毒药和治疗方案以及它们的交互作用对老鼠存活时间有无显著影响。

```{r}
rats <- read.csv("rats.csv",header = T)
pander(rats)
```



##重复测量方差分析