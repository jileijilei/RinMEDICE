---
title: "非参数检验"
author: "梁雪枫"
date: "2014年11月18日"
documentclass: ctexart
output:
  pdf_document:
    fig_caption: yes
    latex_engine: xelatex                               
    number_sections: yes
    template: !expr rticles::ctex_template()
    toc: yes
classoption: "hyperref`r if (.Platform$OS.type != 'windows') ',nofonts'`"
---

```{r include=FALSE}
library(coin)
library(DescTools)
library(mvtnorm)
library(polycor)
library(pROC)
library(rms)
library(reshape2)
```
非参数检验不考虑总体分布是否已知，也不针对总体参数，而是针对总体的某些一般性假设（如总体分布的位置是否相同，总体分布是否正态）进行检验。非参数检验方法简便，不依赖于总体分布的具体形式因而适用性强，但灵敏度和精确度不如参数检验。一般而言，非参数检验适用于以下三种情况：顺序类型的数据资料，这这类数据的分布形态一般是未知的；总体分布形态未知或者非正态的连续型数据，这类数据和卡方检验一样，称自由分布检验；总体分布虽正态，数据也是连续类型，但样本容量极小，如10以下（虽然Ｔ检验被称为小样本统计方法，但样本容量太小时，代表性毕竟很差，最好不要用要求较严格的参数检验法）

##单样本(One-sample)
###符合检验(Sign-test)
符号检验法是通过对两个相关样本的每对数据之差的符号（正号或负号）进行检验，以比较这两个样本所代表的总体的差异显著性，对应于参数检验中两相关样本差异显著性的Ｔ检验。其基本思想是：若两总体差异不显著，则两样本差值的正号与负号应大致各占一半，即中位数为0，可见符号检验是以中数作为统计量进行假设检验的。
例 某药厂生产的胶囊平均长度为13mm，现随机在生产线上抽取10个，测得长度如下：15 13 13 15 13 13 12 12 10  9，生产过程中对长度的控制是否需要调整？
```{r}
leng <- c(15,13,13,15,13,13,12,12,10,9)
SignTest(leng,mu = 13)
```
P值大于0.05，可以认为长度不需要调整。
###Wilcoxon符号秩检验(Wilcoxon signed rank test)
“秩”又称等级、即按数据大小排定的顺序号，顺序号的和称“秩和”，秩和检验就是用秩和作为统计量进行假设检验的方法。Wilcoxon符号秩检验即符号等级检验法是通过对两个相关样本的每对数据之差的符号（正号或负号）及等级进行检验，以比较这两个样本所代表的总体的差异显著性，对应于参数检验中两相关样本差异显著性的Ｔ检验。其基本思想是：若两总体差异不显著，则两样本的正负向差值的等级之和应大致相等，即分布对称，且中位数为0，可见符号检验是以中位数和分布的对称性为统计量进行假设检验的。

例 某地10名儿童智力测验所的IQ如下：99 131 118 112  128 136 120 107 134 122，这10名儿童的智力是否小于等于当地智力中位数110？
```{r}
IQ    <- c(99, 131, 118, 112, 128, 136, 120, 107, 134, 122)
medH0 <- 110
wilcox.test(IQ, alternative="greater", mu=medH0, conf.int=TRUE)
```
P值小于0.05，可以认为这10名儿童的智力大于当地智力中位数110。

##两独立样本(Two independent samples)
###符合检验(Sign-test)
例 在某项研究中，经随机抽样获得甲乙两组病人的血尿素氮(BUN)mmol/L，甲组:4.98  3.90  4.02  0.68  4.98  5.04 1.20  2.64  6.23  3.00,乙组：4.17 4.95 3.96 3.59 4.89 3.03 3.71 5.91 5.55 6.29 4.82 3.90 6.11，试比较甲乙组病人血尿素氮(BUN)的含量有无差别？
```{r}
Nj  <- c(10, 13)
x <- c(4.98,3.90,4.02,0.68,4.98,5.04,1.20,2.64,6.23,3.00)
y <- c(4.17,4.95,3.96,3.59,4.89,3.03,3.71,5.91,5.55,6.29,4.82,3.90,6.11)
wIndDf <- data.frame(DV=c(x, y),
                     IV=factor(rep(1:2, Nj), labels=LETTERS[1:2]))
median_test(DV ~ IV, distribution="exact", data=wIndDf)
```
P值均大于0.05，不能拒绝原假设，可以认为两组病人血尿素氮无差异。

###Wilcoxon符号秩和检验(Wilcoxon rank-sum test)
Wilcoxon符号秩和检验即Mann-Whitney U检验适用于两独立样本的差异显著性检验，用以确定两种总体的分布是否相同，对应于参数检验中两独立样本均数之差的Ｔ检验。
例 在某项研究中，经随机抽样获得甲乙两组病人的血尿素氮(BUN)mmol/L，甲组:4.98  3.90  4.02  0.68  4.98  5.04 1.20  2.64  6.23  3.00,乙组：4.17 4.95 3.96 3.59 4.89 3.03 3.71 5.91 5.55 6.29 4.82 3.90 6.11，试比较甲组病人血尿素氮(BUN)的含量是否大于乙组？
```{r}
#wilcox.test(x,y,exact = FALSE,correct =F) #差异性比较 
#wilcox.test(x,y,exact = FALSE) 
wilcox.test(DV ~ IV, alternative="less", conf.int=TRUE, data=wIndDf)
wilcox_test(DV ~ IV, alternative="less", conf.int=TRUE,
            distribution="exact", data=wIndDf)
```
P值均大于0.05，不能拒绝原假设，可以认为甲组病人血尿素氮(BUN)的含量不大于乙组。

##两非独立样本(Two dependent samples)
###符合检验(Sign-test)
例 在某项减肥药研究中20名志愿者服药前体重为92 103  93  92  74  75  85  68 107 108 113  75  86  79 108  96 121 142  75 120,服药一周后体重为81 106 132 102  91 112  93  66 122  70 102 121  78  97 104 104  73  98 114 100，试比较服药前后的体重是否有差异？
```{r}
pre <- c(92,103,93,92,74,75,85,68,107,108,113,75,86,79,108,96,121,142,75,120)
post <- c(81,106,132,102,91,112,93,66,122,70,102,121,78,97,104,104,73,98,114,100)
wDepDf <- data.frame(id=factor(rep(1:20, times=2)),
                     DV=c(pre, post),
                     IV=factor(rep(0:1, each=20), labels=c("pre", "post")))

medH0  <- 0
DVdiff <- aggregate(DV ~ id, FUN=diff, data=wDepDf)
SignTest(DVdiff$DV, mu=medH0)
```
P值均大于0.05，不能拒绝原假设，可以认为比较服药前后的体重没有差异。

###Wilcoxon符号秩检验(Wilcoxon signed rank test)
例 在某项减肥药研究中20名志愿者服药前体重为92 103  93  92  74  75  85  68 107 108 113  75  86  79 108  96 121 142  75 120,服药一周后体重为81 106 132 102  91 112  93  66 122  70 102 121  78  97 104 104  73  98 114 100，试比较服药前的体重是否小于等于服药后的体重？
```{r}
wilcoxsign_test(DV ~ IV | id, alternative="greater",
                distribution="exact", data=wDepDf)
```
P值均大于0.05，不能拒绝原假设，可以认为比较服药前的体重不大于服药后的体重。

##多组样本(more than two samples)
非参数多组比较法其主要用于等级型数据或不满足参数检验条件的场合，故亦称等级方差分析（ANOVA by ranks）。和方差分析一样，按照实验设计不同，非参数多组比较法也包括适用于完全随机化设计的单向秩次方差分析或称Kruskal-Wallis检验和适用于随机化区组设计的双向秩次方差分析(Friedman检验)。
###无序独立样本(Independent samples - unordered groups)
Kruskal-Wallis检验用来检验多个独立样本的位置是否一样。

例 四组病例测试的智力IQ分别打分如下：A：99, 131, 118, 112, 128, 136, 120, 107, 134, 122，B：134, 103, 127, 121, 139, 114, 121, 132 C：110, 123, 100, 131, 108, 114, 101, 128, 110，D：117, 125, 140, 109, 128, 137, 110, 138, 127, 141, 119, 148 问不同组之间的IQ是否有差异？

```{r}
A  <- c(99, 131, 118, 112, 128, 136, 120, 107, 134, 122)
B  <- c(134, 103, 127, 121, 139, 114, 121, 132)
C  <- c(110, 123, 100, 131, 108, 114, 101, 128, 110)
D  <- c(117, 125, 140, 109, 128, 137, 110, 138, 127, 141, 119, 148)
Nj   <- c(length(A), length(B), length(C), length(D))
KWdf <- data.frame(DV=c(A,B,C,D),
                   IV=factor(rep(1:4, Nj), labels=c("A", "B", "C", "D")))
kruskal.test(DV ~ IV, data=KWdf) #stats包
kruskal_test(DV ~ IV, distribution=approximate(B=9999), data=KWdf) #coin包
pairwise.wilcox.test(KWdf$DV, KWdf$IV, p.adjust.method="holm") #两两比较
```
P值均大于0.05，不能拒绝原假设，可以认为四组的智力没有差异。两两比较结果，没有智力差异。
permutation检验即置换检验，在当样本量不够大，样本分布未知的情况下，用置换检验模拟出样本均值分布，然后再进行比较。
```{r}
oneway_test(DV ~ IV, distribution=approximate(B=9999), data=KWdf)
```
P值均大于0.05，不能拒绝原假设，可以认为四组的智力没有差异。

###有序独立样本(Independent samples - ordered groups)
Jonckheere Terpstra trend检验适用于多个总体有相似的连续分布(除了位置可能不同外)，所有的观察值在样本内和样本间独立。不同于Kruskal-Wallis检验，Jonckheere Terpstra trend检验可以判断是否出现单调的趋势。

例 在一项健康试验中，有3种生活方式，他们一个月后减少的种类如下：A 3.7 3.7 3.0 3.9 2.7 B：7.3 5.2 5.3 5.7 6.5 C：9.0 4.9 7.1 8.7，能否得三种生活方式减肥效果相同？

```{r}
A  <- c(3.7,3.7,3.0,3.9,2.7)
B  <- c(7.3,5.2,5.3,5.7,6.5)
C  <- c(9.0,4.9,7.1,8.7)
Nj <- c(length(A), length(B), length(C))
JTdf <- data.frame(IV=ordered(rep(LETTERS[1:3], Nj)),
                   DV=c(A,B,C))

kruskal_test(DV ~ IV, distribution=approximate(B=9999), data=JTdf)
JonckheereTerpstraTest(DV ~ IV, data=JTdf)
```
p值小于0.05，可以认为三个总体的位置有上升趋势。

###无序非独立样本(Dependent samples - unordered groups)
Friedman检验即双向等级方差分析对应于参数检验中随机区组设计的方差分析
例 现有6条狗服用阿司匹林不同时间（时间）血中的药物浓度数据（r/ml）如下表，问服药后不同时间血中的药物浓度有无差别？

编号  0.5h  1h    6h     8h     24h   48h
----  ---   ---   ---    ---    ---   ---
1     51.6  135.2 169.8  137.2  31.9  0.4
2     49.6  101.6 158.4  133.0  18.7  0.0
3     40.6  88.4  142.8  126.6  18.1  2.0
4     11.2  37.2  131.8  130.3  17.5  0.2
5     17.8  48.2  118.0  124.5  18.7  1.8
6     14.4  41.6  120.8  123.5  24.8  3.0

```{r}
x<-matrix(c(51.6,49.6,40.6,11.2,17.8,14.4,
           135.2,101.6,88.4,37.2,48.2,41.6,
           169.8,158.4,142.8,131.8,118,120.8,
           137.2,133,126.6,130.3,124.5,123.5,
           31.9,18.7,18.1,17.5,18.7,24.8,
           0.4,0,2,0.2,1.8,3
          ),
         nrow = 6,
         byrow = TRUE,
         dimnames = list(1 : 6,c("h1", "h2", "h3","h4","h5","h6")))

friedman.test(x)
```
P值小于0.05，拒绝原假设，可以认为服药后不同时间血中的药物浓度有差异。

例 四种测试的方式，分别测试得到如下：A：14 13 12 11 10 ，B：11 12 13 14 15，C：16 15 14 13 12，D：13 12 11 10 9，问不同的测试方式之间是否有差异？

```{r}
N   <- 5
P   <- 4
DV1 <- c(14, 13, 12, 11, 10)
DV2 <- c(11, 12, 13, 14, 15)
DV3 <- c(16, 15, 14, 13, 12)
DV4 <- c(13, 12, 11, 10,9)
Fdf <- data.frame(id=factor(rep(1:N, times=P)),
                  DV=c(DV1, DV2, DV3, DV4),
                  IV=factor(rep(1:P, each=N),
                            labels=LETTERS[1:P]))
friedman.test(DV ~ IV | id, data=Fdf)
friedman_test(DV ~ IV | id, distribution=approximate(B=9999), data=Fdf)
```
P值小于0.05，拒绝原假设，可以认为四种不同的测试方式之间有差异。

由于本例中样本量较小，置换检验如下
```{r}
oneway_test(DV ~ IV | id, distribution=approximate(B=9999), data=Fdf)
```
置换检验结果表明四种不同的测试方式之间没有差异。

###有序非独立样本(Dependent samples - ordered groups)
Page trend检验对应于参数检验中Spearman's rank相关检验，适用于有序的多组之间的的非参数的趋势检验。
例 四种测试的方式，分别测试得到如下：A：1.79 -3.05  2.44  1.53 -0.43  0.96  0.17  1.55  0.19 -1.21，B：2.43 -3.20  0.73 -3.60 -4.05 -1.91 -5.44  1.97 -3.78 -3.25，C：3.33 -3.50 -0.49  0.87  2.28 -1.25  6.70  2.79  3.53  4.73，D：-3.23  2.00  4.43  3.95  2.54  3.45  0.66  0.91  0.06 -1.47，问不同的测试方式之间是否有差异？

```{r}
A <- c(1.79,-3.05,2.44,1.53,-0.43,0.96,0.17,1.55,0.19,-1.21)
B <- c(2.43,-3.20,0.73,-3.60,-4.05,-1.91,-5.44,1.97,-3.78,-3.25)
C <- c(3.33,-3.50,-0.49,0.87,2.28,-1.25,6.70,2.79,3.53,4.73)
D <- c(-3.23,2.00,4.43,3.95,2.54,3.45,0.66,0.91,0.06,-1.47)

Pdf <- data.frame(id=factor(rep(1:10, times=4)),
                  DV=c(A,B,C,D),
                  IV=ordered(rep(LETTERS[1:4], each=10)))
PageTest(DV ~ IV | id, data=Pdf) #DescTools包
friedman_test(DV ~ IV | id, distribution=approximate(B=9999), data=Pdf) #coin包
```
p值大于0.05，可以认为四种不同的测试方式之间没有差异。

##二项分布检验(Binomial test)
二项分布检验是对二分类变量的拟合优度检验，它考察每个类别中观察值的频数与特定二项分布下的预期频数间是否存在统计学差异。在二项分布检验中，实际上采用的和K-S检验的原理相同，只是这里主要使用的是二分变量，是一个离散分布的检验情况。
###单侧(One-sided)
例 某研究检测7份血清标本，乙肝HBsAg的抗体结果如下："+", "+", "-", "+", "-", "+", "+"，问研究的血清标本阳性率是否小于等于0.25？
```{r}
DV   <- factor(c("+", "+", "-", "+", "-", "+", "+"), levels=c("+", "-"))
N    <- length(DV)
(tab <- table(DV))
pH0 <- 0.25
binom.test(tab, p=pH0, alternative="greater", conf.level=0.95)
```
P值大于0.05，可以认为研究的血清标本阳性率时候小于等于0.25。

###双侧(Two-sided)
例 某研究检测20份血清标本，乙肝HBsAg的抗体有10份是阳性，问研究的血清标本阳性率是否等于0.25？
```{r}
N    <- 20
hits <- 10
binom.test(hits, N, p=pH0, alternative="two.sided")
```
P值小于0.05，可以认为研究的血清标本阳性率时候不等于0.25。

###置信区间(Confidence intervals)
例 某研究检测7份血清标本，乙肝HBsAg的抗体结果如下："+", "+", "-", "+", "-", "+", "+"，问研究的血清标本阳性率和其置信区间？
```{r}
DV   <- factor(c("+", "+", "-", "+", "-", "+", "+"), levels=c("+", "-"))
N    <- length(DV)
tab <- table(DV)
BinomCI(tab[1], sum(tab), method="wilson")
```
该血清阳性率为71.42%，95%置信区间为35.89%~91.77%.

##卡方检验($\chi^{2}$检验)
卡方检验用于两个率或两个构成比之间的比较。
例 三组大白鼠分别为35 16 94只，在不同致癌剂作用下的发病数分别为15 6 39，问不同组只见发病数是否有差别？
```{r}
total <- c(35, 16, 94)
hits  <- c(15,6,39)
prop.test(hits, total)
```
P值大于0.05，不能拒绝零假设，不能认为三组之间的发病数有差异。

##游程检验(Runs-test)
游程检验即单样本变量值的随机性检验，其一个或多个的代表相同属性或类型的接连出现区段称为游程。游程检验主要是用来检验数据是否为随机性取得。 
例 某村发生一种地方病，其住户沿一条河排列，调查时对发病的住户标记为“t”，对非发病的住户标记为“f”，共8户，其取值如下表所示:"f", "t", "t", "f", "t", "f", "f", "f",问该地方的发病是否随机？
```{r}
queue <- factor(c("f", "t", "t", "f", "t", "f", "f", "f"))
RunsTest(queue, alternative="greater")
```
P值大于0.05，可以认为地方病的发病是随机的。

###置换检验(Manual permutation test)
样本数较少，实现置换检验
```{r}
Nj    <- table(queue)
(runs <- rle(levels(queue)[as.numeric(queue)]))
(rr <- length(runs$lengths))
(rr1 <- table(runs$values)[1])
(rr2 <- table(runs$values)[2])
getP <- function(r1, r2, n1, n2) {
    # iterations of a symbol <= total number of this symbol?
    stopifnot(r1 <= n1, r2 <= n2)

    # probability in case r1+r2 is uneven
    p <- (choose(n1-1, r1-1) * choose(n2-1, r2-1)) / choose(n1+n2, n1)

    # probability in case r1+r2 is even: twice the uneven case
    ifelse(((r1+r2) %% 2) == 0, 2*p, p)
}

n1 <- Nj[1]
n2 <- Nj[2]
N <- sum(Nj)
rMin  <- 2
(rMax <- ifelse(n1 == n2, N, 2*min(n1, n2) + 1))
p3.2 <- getP(3, 2, n1, n2)
p2.3 <- getP(2, 3, n1, n2)
p3.3 <- getP(3, 3, n1, n2)
p4.3 <- getP(4, 3, n1, n2)
(pGrEq <- p3.2 + p2.3 + p3.3 + p4.3)
p2.2 <- getP(2, 2, n1, n2)
p1.2 <- getP(1, 2, n1, n2)
p2.1 <- getP(2, 1, n1, n2)
p1.1 <- getP(1, 1, n1, n2)
(pLess <- p2.2 + p1.2 + p2.1 + p1.1)
pGrEq + pLess
```

对上述游程进行检验可用正态近似法
```{r}
muR   <- 1 + ((2*n1*n2) / N)
varR  <- (2*n1*n2*(2*n1*n2 - N)) / (N^2 * (N-1))
rZ    <- (rr-muR) / sqrt(varR)
(pVal <- 1-pnorm(rZ))
```

##无序分类联合检验(Association tests and measures for unordered categorical variables)
###(2×2)列联表
Fishe精确检验是检验两个二分类变量是否是独立的一种检验。

例 某疾病的影像学诊断和疾病的确诊结果如下，问影像学诊断和确诊结果是否有差别？
        
疾病    isHealthy  isIll
---     ---        ---
no      8          2  
yes     1          4 
    
```{r}
disease <- factor(rep(c("no", "yes"),   c(10, 5)))
diagN   <- rep(c("isHealthy", "isIll"), c( 8, 2))
diagY   <- rep(c("isHealthy", "isIll"), c( 1, 4))
diagT   <- factor(c(diagN, diagY))
contT1  <- table(disease, diagT)
addmargins(contT1)
fisher.test(contT1)
```
P值大于0.05，可以认为影像学诊断和确诊结果没有差别。

###灵敏度、特异度等(Prevalence, sensitivity, specificity, CCR, F-score)
```{r}
TN <- c11 <- contT1[1, 1]       ## true negative 真阴性
TP <- c22 <- contT1[2, 2]       ## true positive / hit 真阳性
FP <- c12 <- contT1[1, 2]       ## false positive 假阳性
FN <- c21 <- contT1[2, 1]       ## false negative / miss 假阴性

(prevalence <- sum(contT1[2, ]) / sum(contT1)) #盛行率
(sensitivity <- recall <- TP / (TP+FN))  #灵敏度
(specificity <- TN / (TN+FP))  #特异度
(relevance <- precision <- TP / (TP+FP)) #阳性预测值
(CCR <- sum(diag(contT1)) / sum(contT1)) #正确分类率 accuracy = (TP + TN)/(TP + FP + FN + TN)
(Fval <- 1 / mean(1 / c(precision, recall))) #F得分 = 2*TP /(2*TP + FP + FN) % 
```

### OR值、相对危险度等(Odds ratio, Yule's Q and risk ratio)
```{r}
(OR <- OddsRatio(contT1, conf.level=0.95)) # OR值
YuleQ(contT1)  ## Goodman-Kruskal γ值，属于2×2四格表的列联比例函数
RelRisk(contT1) #相对危险度
(risk    <- prop.table(contT1, margin=1))
(relRisk <- risk[1, 1] / risk[2, 1]) #相对危险度
```

###(r×c)列联表
例 某研究得出吸烟和冠心病疾病的严重程度人数分布如下表，问吸烟和冠心病疾病的严重程度是否有关？

smokes  轻   中   重
---     ---  ---  ---
no      5    21   6
yes     4    13   1 
```{r}
table2flat <- function(mytable){
  df <- as.data.frame(mytable)
  rows <- dim(df)[1]
  cols <- dim(df)[2]
  x <- NULL
  for(i in 1:rows){
    for(j in 1:as.integer(as.character(df$Freq[i]))){
      row <- df[i,c(1:(cols-1))]
      x <- rbind(x,row)
    }
  }
  row.names(x) <- c(1:dim(x)[1])
  return(x)
}

smokes <- rep(c("no","yes"),times=1)
siblings <- rep(c("1","2","3"),each=2)
Freq <- c(5,4,21,13,6,1)
mytable <- as.data.frame(cbind(smokes,siblings,Freq))
mydata <- table2flat(mytable)
cTab <- table(mydata)
cTab
addmargins(cTab)
chisq.test(cTab)
```
p值大于0.05，可以认为吸烟和冠心病疾病的严重程度无关。

#### \(\phi\), Cramer's \(V\), contingency coefficient等值
```{r}
Assocs(cTab)
```

####Cochran-Mantel-Haenszel 检验
MHC 检验在存在第三个类别变量的情况下有条件地检验两个二分类变量的关联度。

例 检验在A、B两组组别因素存在的情况下，性别和工作而分类变量的关联度
```{r}
set.seed(123)
myDf <- data.frame(work =factor(sample(c("home", "office"), 10, replace=TRUE)),
                   sex=factor(sample(c("f", "m"),10, replace=TRUE)),
                   group=factor(sample(c("A", "B"), 10, replace=TRUE)))
tab3 <- xtabs(~ work + sex + group, data=myDf)
tab3
cmh_test(tab3, distribution=approximate(B=9999))
```
P值大于0.05，可以认为性别和工作无关联。

##有序分类联合检验(Association tests and measures for ordered categorical variables)
###线性间的联合检验(Linear-by-linear association test)
线性间的联合检验检验两有序变量之间升高或降低的变化趋势。

例  下表表示不同年龄组血液病患者真菌感染发生的严重分级情况，是否年龄组越高，感染越重？
年龄   I      II      III     IV
---    ---    ---     ---     ---
<=29   1      5       6       9 
30~59  5      7       6       7
>=60   8      9       13      10

```{r}
age <- rep(c("Q","Z","L"),times=4)
severity <- rep(c("I","II","III","IV"),each=3)
Freq <- c(1,5,8,5,7,9,6,6,13,9,7,10)
mytable <- as.data.frame(cbind(age,severity,Freq))
dfOrd <- table2flat(mytable)
cTab <- xtabs(~ age + severity, data=dfOrd)
addmargins(cTab)
lbl_test(cTab, distribution=approximate(B=9999))
```
P值大于0.05，不能认为年龄越高真菌感染的严重程度越重。

###多序列相关(Polychoric and polyserial correlation)
Polychoric相关是估计从两个从有序分类变量所获得的两个近似连续正态分布的潜变量（latent variables）之间的相关。
```{r}
polychor(dfOrd$age, dfOrd$severity, ML=TRUE)
#polychor(cTab, ML=TRUE)
```

polyserial相关是估计一个连续性变量和一个有序分类的变量之间的相关。
```{r}
x <- rnorm(86,mean = 23,sd=10) 
polyserial(x, dfOrd$severity) #两步骤估计
polyserial(x, dfOrd$severity,ML=TRUE, std.err=TRUE) #ML估计 
```

###异构相关矩阵(Heterogeneous correlation matrices)
```{r}
N <- 100
Sigma <- matrix(c(4,2,-3, 2,16,-1, -3,-1,9), byrow=TRUE, ncol=3)
mu<- c(-3, 2, 4)
Xdf   <- data.frame(rmvnorm(n=N, mean=mu, sigma=Sigma))
lOrd   <- lapply(Xdf, function(x) {
  cut(x, breaks=quantile(x), include.lowest=TRUE,
      ordered=TRUE, labels=LETTERS[1:4]) })
dfOrd  <- data.frame(lOrd)

Xdf2<- rmvnorm(n=N, mean=mu, sigma=Sigma) #产生随机多元正态分布
dfBoth <- cbind(Xdf2, dfOrd)
hetcor(dfBoth, ML=TRUE)
```

###有序变量和连续性变量(Association measures involving categorical and continuous variables)
对有序分类变量和连续性变量的相关测量，可以使用rms包中建立Logistic模型的lmr函数，AUC等指标可从模型的stats中获得。
```{r}
set.seed(123)
N   <- 100
x   <- rnorm(N)
y   <- x + rnorm(N, 0, 2)
yDi <- ifelse(y <= median(y), 0, 1)

lrm(yDi ~ x)$stats

#绘制ROC曲线
(rocRes <- roc(yDi ~ x, plot=TRUE, ci=TRUE, main="ROC-curve",
               xlab="specificity (TN / (TN+FP))", ylab="sensitivity (TP / (TP+FN))"))
rocCI <- ci.se(rocRes)
plot(rocCI, type="shape")
```

##Cochran Q检验(Cochran-Q-test)
Cochran-Q检验是对多个变量的二分数据具有同一分布的检验。检验的数据是二分类数据，且数据是0或1两种编码。

例 某研究调查了20名患者，对四个医院的满意情况，满意用1表示，不满意用0表示。
```{r}
data_wide <- read.csv("Cochran.csv",header = T)
data_wide
```

```{r}
data_long <- melt(data_wide, id.vars = NULL) #转为长格式
id=factor(rep(1:20,times=4))
cdf <- data.frame(id,data_long)
cdf$value <- as.numeric(cdf$value) #转为数字
symmetry_test(value~variable  | id, teststat="quad", data=cdf)
```
P值小于0.05，可以认为对四个医院的满意情况有差异。

##McNemar检验(McNemar test)
McNemar检验用于配对计数资料的分析，主要分析配对资料中对照组和处理组的频数或比率是否有差异。常用于同一批观察对象用药前后或试验前后的结果是否有差异。

例 同一批病例治疗前后症状研究结果如下，试分析治疗前后是否有差异？

       后有    后无  
---    ---     ---
前有    3       5
前无    6       6

```{r}
pre <- rep(c("yes","no"),times=2)
post <- rep(c("yes","no"),each=2)
Freq <- c(3,6,5,6)
mytable <- as.data.frame(cbind(pre,post,Freq))
mydata <- table2flat(mytable)
cTab    <- table(mydata$pre, mydata$post)
addmargins(cTab)
mcnemar.test(cTab, correct=FALSE)
symmetry_test(cTab, teststat="quad", distribution=approximate(B=9999)) #coin包
```
P值大于0.05，不但能认为治疗前后的症状有差异。

##Bowker 检验(Bowker test)
对于配对设计的二分类资料，通常使用McNemar检验，而对于配对设计多分类资料，使用Bowker检验，是McNemar检验的一般化。

例 两名放射科医生对203名棉屑沉着病可疑患者的诊断结果见下表。试分析两名医生诊断的结果是否相同。

	   I	   II	   III
---  ---   ---   ---
I	   78	   5	   2
II	 6	   56	   12
III  2	   10	   32

```{r}
A <- rep(c("I","II","III"),times=3)
B <- rep(c("I","II","III"),each=3)
Freq <- c(78,6,2,5,56,10,2,12,32)
mytable <- as.data.frame(cbind(A,B,Freq))
mydata <- table2flat(mytable)
cTab  <- table(mydata$A, mydata$B)
addmargins(cTab)
mcnemar.test(cTab) #对于大于2*2的列联表mcnemar.test自动采用Bowke检验
symmetry_test(cTab, teststat="quad", distribution=approximate(B=9999)) #coin包
```
P值大于0.05，不但能认为两医生的诊断有差异。
